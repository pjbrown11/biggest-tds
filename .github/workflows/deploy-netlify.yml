name: Build & Deploy (Netlify)

on:
    workflow_dispatch:
        inputs:
            run_deploy:
                description: "Deploy to Netlify? (true/false)"
                required: false
                default: "true"
    schedule:
        # 6:00 AM America/Chicago (Central) on Tuesdays = 11:00 UTC
        - cron: "0 11 * * TUE"

permissions:
    contents: write

jobs:
    build:
        runs-on: ubuntu-latest
        env:
            NODE_ENV: production
            # Ensure Puppeteer downloads Chrome during the run
            PUPPETEER_SKIP_DOWNLOAD: "false"

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # allow committing/pushing back

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: |
                      package-lock.json
                      site/package-lock.json

            - name: Install root deps (if present)
              run: |
                  if [ -f package-lock.json ]; then npm ci; fi

            - name: Install site deps (include dev for Puppeteer)
              run: |
                  cd site
                  npm ci --include=dev

            - name: Install Chromium for Puppeteer
              run: |
                  cd site
                  npx puppeteer browsers install chrome

            # Runs your root script that generates data and builds the SvelteKit app
            - name: Build site (runs data scripts + SvelteKit build)
              run: |
                  npm run build-site

            # ---- README "latest build" summary block ----
            - name: Update README (latest build info)
              run: |
                  node << 'EOF'
                  const fs = require('fs');
                  const path = require('path');

                  const readJSON = (p) => {
                    try { return JSON.parse(fs.readFileSync(p,'utf8')); } catch { return []; }
                  };

                  const trades = readJSON('site/src/data/trades/trades-current-year.json');
                  const standings = readJSON('site/src/data/standings/standings-current-year.json');
                  // Try both potential paths for rankings
                  const ranks = (() => {
                    const p1 = 'site/src/data/drafts/dynasty-rankings.json';
                    const p2 = 'site/src/routes/drafts/dynasty-rankings-local.json';
                    if (fs.existsSync(p1)) return readJSON(p1);
                    if (fs.existsSync(p2)) return readJSON(p2);
                    return [];
                  })();

                  const repo = process.env.GITHUB_REPOSITORY || '';
                  const runId = process.env.GITHUB_RUN_ID || '';
                  const sha = (process.env.GITHUB_SHA || '').slice(0,7);
                  const runUrl = repo && runId ? `https://github.com/${repo}/actions/runs/${runId}` : '';
                  const when = new Date().toISOString().replace('T',' ').replace('Z',' UTC');

                  const block = `
                  <!--build-summary:start-->
                  **Latest automated build:** ${when}  
                  **Workflow run:** ${runUrl ? `[#${runId}](${runUrl})` : runId}  
                  **Commit:** \`${sha}\`

                  **Data snapshot**
                  - Trades (current year): ${trades.length}
                  - Standings rows (current year): ${standings.length}
                  - Dynasty rankings scraped: ${ranks.length}
                  <!--build-summary:end-->
                  `.trim();

                  const readmePath = path.resolve('readme.md');
                  let readme = fs.existsSync(readmePath) ? fs.readFileSync(readmePath, 'utf8') : '# Project\n';

                  const start = '<!--build-summary:start-->';
                  const end = '<!--build-summary:end-->';

                  if (readme.includes(start) && readme.includes(end)) {
                    const pre = readme.split(start)[0];
                    const post = readme.split(end)[1];
                    readme = `${pre}${block}${post}`;
                  } else {
                    readme += `\n\n${block}\n`;
                  }

                  fs.writeFileSync(readmePath, readme);
                  console.log('README updated.');
                  EOF

            # Commit only the generated data + README (never the build output)
            - name: Commit updated data (if any)
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git add \
                    README.md \
                    site/src/data/trades/trades-current-year.json \
                    site/src/data/standings/standings-current-year.json \
                    site/src/routes/drafts/dynasty-rankings-local.json \
                    site/src/data/drafts/dynasty-rankings.json || true

                  if ! git diff --cached --quiet; then
                    git commit -m "chore(ci): update generated data + build summary [skip ci]"
                    git push
                  else
                    echo "No data/README changes to commit."
                  fi

            - name: Upload build artifact (optional)
              uses: actions/upload-artifact@v4
              with:
                  name: site-build
                  path: site/build

            - name: Deploy to Netlify
              if: ${{ github.event_name == 'schedule' || github.event.inputs.run_deploy != 'false' }}
              run: |
                  npx --yes netlify-cli deploy --dir=site/build --prod --site="$NETLIFY_SITE_ID"
              env:
                  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
